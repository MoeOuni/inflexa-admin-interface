import{g as $,A as x,r as b,$ as V,_ as z,j as e,a as w,h as A,i as T,k as L,f as E,d as U,l as I,m as B,n as M}from"./index-3nPIAQnH.js";import{B as C}from"./button-CtZ5qbJi.js";import{I as p}from"./input-CN_5s6Mi.js";import{u as W,F as G,a as j,b as g,c as h,d as F,e as v,t as H}from"./index-CWNnVEfM.js";import{P as J}from"./customer-BYiiW8fW.js";import{u as S}from"./useMutation-D9iDBiiT.js";import{p as N}from"./purchase-query-keys-BZk4QrP-.js";import{a as _}from"./api-clients-BUUlQTs0.js";import{d as q}from"./dayjs.min-DLk4Du8q.js";import{u as X}from"./use-supplier-1udlx5vf.js";import{C as Y,a as Z,b as ee,c as se,d as te,e as ae,f as ne}from"./command-D_T3vcN9.js";import{P as re,a as ie,b as oe}from"./popover-BxiKflDC.js";import{C as le}from"./check-BMG6f9gN.js";import{$ as D}from"./index-_x51y03b.js";import"./label-3kCfBlTx.js";import"./supplier-query-keys-DIv9u3_S.js";import"./index-G51GvTtm.js";import"./Combination-CsG-0PjX.js";const de=async s=>await _.post("/purchases",s);function ce(){const s=$();return S({mutationFn:de,onSuccess:()=>{s.invalidateQueries({queryKey:N.all}),x.success("Purchase created successfully.")},onError:t=>{var a,n;x.error(((n=(a=t==null?void 0:t.response)==null?void 0:a.data)==null?void 0:n.message)||"An error occurred. Please try again.")}})}function me(){const s=$();return S({mutationFn:async a=>await _.put(`/purchases/${a==null?void 0:a._id}`,a),onMutate:async()=>{await s.cancelQueries({queryKey:N.all})},onSuccess:()=>{s.invalidateQueries({queryKey:N.all}),x.success("Purchase updated successfully.")},onError:a=>{var n,l;x.error(((l=(n=a==null?void 0:a.response)==null?void 0:n.data)==null?void 0:l.message)||"An error occurred. Please try again.")},onSettled:()=>{s.invalidateQueries({queryKey:N.all})}})}const ue=async s=>await _.post("/inventory",s);function xe(){const s=$();return S({mutationFn:ue,onSuccess:()=>{s.invalidateQueries({queryKey:y.all}),x.success("Inventory created successfully.")},onError:t=>{var a,n;x.error(((n=(a=t==null?void 0:t.response)==null?void 0:a.data)==null?void 0:n.message)||"An error occurred. Please try again.")}})}const y={all:["inventories"],details:()=>[...y.all,"detail"],detail:s=>[...y.details(),s],pagination:s=>[...y.all,"pagination",s],infinite:()=>[...y.all,"infinite"]},P="horizontal",fe=["horizontal","vertical"],O=b.forwardRef((s,t)=>{const{decorative:a,orientation:n=P,...l}=s,d=Q(n)?n:P,r=a?{role:"none"}:{"aria-orientation":d==="vertical"?d:void 0,role:"separator"};return b.createElement(V.div,z({"data-orientation":d},r,l,{ref:t}))});O.propTypes={orientation(s,t,a){const n=s[t],l=String(n);return n&&!Q(n)?new Error(pe(l,a)):null}};function pe(s,t){return`Invalid prop \`orientation\` of value \`${s}\` supplied to \`${t}\`, expected one of:
  - horizontal
  - vertical

Defaulting to \`${P}\`.`}function Q(s){return fe.includes(s)}const R=O,K=b.forwardRef(({className:s,orientation:t="horizontal",decorative:a=!0,...n},l)=>e.jsx(R,{ref:l,decorative:a,orientation:t,className:w("shrink-0 bg-border",t==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...n}));K.displayName=R.displayName;function k({purchase:s,currency:t}){var a,n,l,d,c;return e.jsx("div",{className:"bg-muted/40 border rounded-lg p-6",children:e.jsxs("div",{className:"grid gap-4 text-sm",children:[e.jsxs("div",{className:"font-semibold",children:["Purchase Details: ",s==null?void 0:s.reference]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Supplier"}),e.jsx("span",{children:s==null?void 0:s.supplierLabel})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Date"}),e.jsx("span",{children:s.createdAt})]}),(a=s==null?void 0:s.purchaseDetails)!=null&&a.length?e.jsxs(e.Fragment,{children:[e.jsx("ul",{className:"grid gap-3 ",children:(n=s.purchaseDetails)==null?void 0:n.map((r,i)=>e.jsxs("li",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-muted-foreground",children:[r.name," x ",e.jsx("span",{children:r.quantity})]}),e.jsxs("span",{children:[(r.price*r.quantity).toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2})," ",t==null?void 0:t.symbol]})]},i))}),e.jsx(K,{className:"my-2"}),e.jsxs("ul",{className:"grid gap-3 ",children:[e.jsxs("li",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Total ET"}),e.jsxs("span",{children:[((l=A(s.purchaseDetails))==null?void 0:l.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0," ",t==null?void 0:t.symbol]})]}),e.jsxs("li",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Total Taxes"}),e.jsxs("span",{children:[((d=T(s.purchaseDetails))==null?void 0:d.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0," ",t==null?void 0:t.symbol]})]}),e.jsxs("li",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-muted-foreground",children:"Total Price"}),e.jsxs("span",{children:[((c=L(s.purchaseDetails))==null?void 0:c.toLocaleString(void 0,{minimumFractionDigits:2,maximumFractionDigits:2}))??0," ",t==null?void 0:t.symbol]})]})]})]}):e.jsx(e.Fragment,{})]})})}function je({purchase:s,setPurchase:t,setSteps:a}){const n=xe(),l=me(),{tax:d,currency:c}=E(),r=W({resolver:H(J),defaultValues:{reference:"",name:"",price:0,tax:d,quantity:1,unit:""},mode:"onChange"}),i=async()=>{const o={_id:s._id,reference:s.reference,supplier:s.supplierId,totalPrice:L(s.purchaseDetails)??0,totalWithoutTax:A(s.purchaseDetails)??0,totalTax:T(s.purchaseDetails)??0,broughtAt:q(s.createdAt).toDate()};await l.mutateAsync(o),t({reference:"",supplierId:"",supplierLabel:"",createdAt:"",purchaseDetails:[],total:0}),a(0)},f=async o=>{try{if(!(s!=null&&s._id))return x.error("Purchase not created yet try again. or cantact the support team.");const u={...o,supplier:s==null?void 0:s.supplierId,purchaseId:s==null?void 0:s._id,purchaseReference:s==null?void 0:s.reference};await n.mutateAsync(u);const m=s.purchaseDetails||[];m.push(o),t({...s,purchaseDetails:m}),r.reset({reference:"",name:"",price:0,tax:d,quantity:1,unit:""})}catch{x.error("An error occurred while saving the product.")}};return e.jsxs("div",{className:"grid md:grid-cols-[350px_1fr] gap-4  mx-auto ",children:[e.jsx(k,{purchase:s,currency:c}),e.jsx(G,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(f),className:"grid border p-4 bg-muted/40 rounded-lg gap-6",children:[e.jsxs("div",{className:"grid md:grid-cols-2 gap-4 ",children:[e.jsx("div",{className:"grid gap-4",children:e.jsx(j,{name:"name",control:r.control,render:({field:o})=>e.jsxs(g,{children:[e.jsx(h,{children:"Product Name"}),e.jsx(F,{children:e.jsx(p,{...o})}),e.jsx(v,{})]})})}),e.jsx("div",{className:"grid gap-4",children:e.jsx(j,{name:"reference",control:r.control,render:({field:o})=>e.jsxs(g,{children:[e.jsx(h,{children:"Reference"}),e.jsx(F,{children:e.jsx(p,{...o})}),e.jsx(v,{})]})})})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsx(j,{name:"price",control:r.control,render:({field:o})=>e.jsxs(g,{children:[e.jsxs(h,{children:["Price (",c==null?void 0:c.symbol,")"]}),e.jsx(p,{type:"number",step:"0.01",min:0,...o,onChange:u=>{const m=parseFloat(u.target.value);o.onChange(typeof m=="number"&&m)}}),e.jsx(v,{})]})}),e.jsx(j,{name:"tax",control:r.control,render:({field:o})=>e.jsxs(g,{children:[e.jsx(h,{children:"Tax"}),e.jsx(p,{type:"number",step:"0.01",min:0,...o,onChange:u=>{const m=parseFloat(u.target.value);o.onChange(typeof m=="number"&&m)}}),e.jsx(v,{})]})})]}),e.jsxs("div",{className:"grid md:grid-cols-2 gap-4",children:[e.jsx(j,{name:"unit",control:r.control,render:({field:o})=>e.jsxs(g,{children:[e.jsx(h,{children:"Unit"}),e.jsx(F,{children:e.jsx(p,{...o})}),e.jsx(v,{})]})}),e.jsx(j,{name:"quantity",control:r.control,render:({field:o})=>e.jsxs(g,{children:[e.jsx(h,{children:"Quantity"}),e.jsx(p,{type:"number",min:0,step:"0.01",...o,onChange:u=>{const m=parseFloat(u.target.value);o.onChange(typeof m=="number"&&m)}}),e.jsx(v,{})]})})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx(C,{type:"button",variant:"outline",onClick:i,children:"Finish"}),e.jsx(C,{type:"submit",children:"Save"})]})]})})]})}function ge({items:s,value:t,onChange:a,placeholder:n}){var c;const[l,d]=b.useState(!1);return e.jsxs(re,{open:l,onOpenChange:d,children:[e.jsx(ie,{asChild:!0,children:e.jsxs(C,{variant:"outline",role:"combobox","aria-expanded":l,className:"w-full justify-between",children:[t?(c=s.find(r=>r.value===t))==null?void 0:c.label:`Select ${n}...`,e.jsx(Y,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})}),e.jsx(oe,{className:"p-0",children:e.jsxs(Z,{className:"",children:[e.jsx(ee,{className:"",placeholder:`Search ${n}...`}),e.jsxs(se,{className:"",children:[e.jsxs(te,{children:["No ",n," found."]}),e.jsx(ae,{children:s.map(r=>e.jsxs(ne,{value:r.value,onSelect:i=>{var u;const f=i===t?"":i,o=i===t?"":(u=s.find(m=>m.value===f))==null?void 0:u.label;a(f,o),d(!1)},children:[e.jsx(le,{className:w("mr-2 h-4 w-4",t===r.value?"opacity-100":"opacity-0")}),r.label]},r.value))})]})]})})]})}const he=({purchase:s,setPurchase:t})=>{var c,r;const{currency:a}=E(),n=X({status:"ACTIVE"}),l=(i,f)=>{t({...s,supplierId:i,supplierLabel:f})},d=i=>{t({...s,createdAt:i})};return e.jsxs("div",{className:"grid md:grid-cols-[350px_1fr] gap-4  mx-auto ",children:[e.jsx(k,{purchase:s,currency:a}),e.jsxs("div",{className:"w-full  flex bg-muted/40 border rounded-lg flex-col gap-4 p-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{children:"Supplier"}),e.jsx(ge,{value:s==null?void 0:s.supplierId,onChange:l,placeholder:"supplier",items:(n==null?void 0:n.status)!=="success"?[]:(r=(c=n==null?void 0:n.data)==null?void 0:c.suppliers)==null?void 0:r.map(i=>({label:i==null?void 0:i.companyName,value:i==null?void 0:i._id}))})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{children:"Date"}),e.jsx(p,{id:"date",type:"date",value:s==null?void 0:s.createdAt,onChange:i=>d(i.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{children:"Reference"}),e.jsx(p,{id:"reference",placeholder:"Enter reference",value:s.reference,onChange:i=>t({...s,reference:i.target.value})})]})]})]})},Oe=()=>{const s=ce(),{t}=U(),[a,n]=I("__purchase_form",{defaultValue:{_id:"",reference:"",supplierId:"",supplierLabel:"",createdAt:"",purchaseDetails:[],total:0}}),[l,d]=I("__supplier_form_step",{defaultValue:0}),{id:c}=B(),r=async()=>{if(a!=null&&a.supplierId){if(!(a!=null&&a.reference))return x.error(t("errors.error_required_reference"))}else return x.error(t("errors.error_required_id_supplier"));const i={reference:a.reference,supplier:a.supplierId,totalPrice:0,totalWithoutTax:0,totalTax:0,broughtAt:q(a.createdAt).toDate()};await s.mutateAsync(i),d(1)};return b.useEffect(()=>{var i,f,o;if(s.isSuccess)return n({...a,_id:(o=(f=(i=s==null?void 0:s.data)==null?void 0:i.data)==null?void 0:f.purchase)==null?void 0:o._id})},[s==null?void 0:s.isSuccess]),e.jsx(e.Fragment,{children:!c&&e.jsx("div",{children:l===0?e.jsxs("div",{children:[e.jsx(he,{purchase:a??{reference:"",supplierId:"",supplierLabel:"",createdAt:"",purchaseDetails:[],total:0,_id:""},setPurchase:n}),e.jsx("div",{className:"flex justify-end",children:e.jsxs(C,{onClick:r,disabled:s.isPending,children:[s.isPending&&e.jsx(M,{className:"mr-2 h-4 w-4 animate-spin"}),"Next"]})})]}):e.jsx(je,{purchase:a??{reference:"",supplierId:"",supplierLabel:"",createdAt:"",purchaseDetails:[],total:0,_id:""},setPurchase:n,setSteps:d})})})};export{Oe as default};
